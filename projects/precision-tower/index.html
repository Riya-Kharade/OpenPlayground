<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>üß± THE PRECISION TOWER ¬∑ structural collapse engine</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      background: linear-gradient(145deg, #1f2839, #131d2b);
      font-family: 'Inter', 'Segoe UI', system-ui, sans-serif;
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }

    .tower-lab {
      max-width: 1300px;
      width: 100%;
      background: #2b364fd9;
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      border-radius: 70px 70px 60px 60px;
      padding: 30px 30px 35px;
      border: 3px solid #8fa8cf;
      box-shadow: 0 30px 45px -15px #030814, inset 0 2px 8px #bfd5ff;
    }

    /* header with stats */
    .tower-header {
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      justify-content: space-between;
      background: #30405bcc;
      border-radius: 90px;
      padding: 12px 30px 12px 35px;
      margin-bottom: 25px;
      border: 2px solid #b7cdf5;
    }

    .title-area {
      display: flex;
      align-items: center;
      gap: 18px;
    }

    .title-area h1 {
      font-size: 2.8rem;
      font-weight: 500;
      background: linear-gradient(145deg, #dae6ff, #b0c6f0);
      -webkit-background-clip: text;
      background-clip: text;
      color: transparent;
      letter-spacing: 1.5px;
    }

    .stats {
      display: flex;
      gap: 25px;
    }

    .stat-box {
      background: #3c4f74;
      border-radius: 50px;
      padding: 8px 24px;
      color: #f2f0d7;
      font-size: 1.3rem;
      font-weight: 600;
      border: 2px solid #c2d4ff;
    }

    /* main area: canvas + side panel */
    .construction-zone {
      display: flex;
      flex-wrap: wrap;
      gap: 25px;
      margin-bottom: 25px;
    }

    .canvas-holder {
      flex: 3;
      min-width: 600px;
      background: #233045;
      border-radius: 60px;
      padding: 15px;
      border: 3px solid #99b5e3;
      box-shadow: inset 0 0 30px #0f1a2a;
    }

    #towerCanvas {
      display: block;
      width: 100%;
      height: auto;
      background: #1d293e;
      border-radius: 50px;
      cursor: crosshair;
    }

    /* tool panel */
    .tool-panel {
      flex: 1;
      min-width: 260px;
      background: #2f3d5bcc;
      border-radius: 60px;
      padding: 25px 20px;
      border: 3px solid #99b5e3;
    }

    .tool-section {
      margin-bottom: 35px;
    }

    .tool-title {
      color: #ebf0ff;
      font-size: 1.6rem;
      margin-bottom: 20px;
      display: flex;
      align-items: center;
      gap: 10px;
      border-bottom: 2px solid #7c93c7;
      padding-bottom: 8px;
    }

    .block-palette {
      display: flex;
      flex-wrap: wrap;
      gap: 15px;
      justify-content: center;
    }

    .block-card {
      background: #405880;
      border-radius: 40px;
      padding: 15px 18px;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 6px;
      border: 3px solid #b3c9ff;
      box-shadow: 0 7px 0 #253856;
      cursor: pointer;
      transition: 0.07s;
      width: 100px;
    }

    .block-card.active {
      background: #6080b5;
      border-color: #ffec9e;
      transform: scale(1.02);
    }

    .block-card:active {
      transform: translateY(7px);
      box-shadow: 0 1px 0 #253856;
    }

    .block-emoji {
      font-size: 2.8rem;
    }

    .block-weight {
      background: #1f2d44;
      border-radius: 30px;
      padding: 4px 12px;
      color: #d6e5ff;
      font-size: 1rem;
    }

    /* simulation controls */
    .sim-controls {
      display: flex;
      flex-direction: column;
      gap: 18px;
    }

    .action-btn {
      background: #5575a5;
      border: none;
      color: #f4f2d8;
      font-size: 1.5rem;
      padding: 18px 25px;
      border-radius: 70px;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 12px;
      cursor: pointer;
      box-shadow: 0 8px 0 #2f456b;
      transition: 0.07s;
      border: 2px solid #b6d2ff;
      font-weight: 600;
    }

    .action-btn:active {
      transform: translateY(8px);
      box-shadow: 0 2px 0 #2f456b;
    }

    .action-btn.danger {
      background: #aa6d6d;
      box-shadow: 0 8px 0 #6e4040;
    }

    .slider-block {
      background: #283753;
      border-radius: 50px;
      padding: 18px 20px;
      border: 2px solid #8da8da;
    }

    .slider-block label {
      color: #ecf0ff;
      font-size: 1.3rem;
      display: block;
      margin-bottom: 10px;
    }

    input[type=range] {
      width: 100%;
      height: 8px;
      background: #3b5077;
      border-radius: 10px;
    }

    #gravityValue {
      color: #fce48c;
      font-weight: 600;
    }

    /* collapse log */
    .collapse-log {
      background: #1b253bb3;
      border-radius: 50px;
      padding: 20px 25px;
      border: 2px solid #8fa3d1;
    }

    .log-header {
      display: flex;
      align-items: center;
      gap: 12px;
      color: #f5f0c0;
      font-size: 1.4rem;
      margin-bottom: 12px;
    }

    #logContainer {
      min-height: 60px;
      color: #c7d3f0;
      font-size: 1.1rem;
      font-style: italic;
    }
  </style>
</head>
<body>
  <div class="tower-lab">
    <div class="tower-header">
      <div class="title-area">
        <h1>üß± PRECISION TOWER</h1>
      </div>
      <div class="stats">
        <div class="stat-box" id="blockCounter">0 blocks</div>
        <div class="stat-box" id="stressIndicator">‚öñÔ∏è stable</div>
      </div>
    </div>

    <div class="construction-zone">
      <!-- canvas for tower -->
      <div class="canvas-holder">
        <canvas id="towerCanvas" width="800" height="500"></canvas>
      </div>

      <!-- tool panel -->
      <div class="tool-panel">
        <div class="tool-section">
          <div class="tool-title"><span>üß©</span> block types</div>
          <div class="block-palette" id="blockPalette"></div>
        </div>

        <div class="tool-section">
          <div class="tool-title"><span>‚öôÔ∏è</span> simulation</div>
          <div class="sim-controls">
            <button class="action-btn" id="simulateBtn">üåÄ simulate collapse</button>
            <button class="action-btn" id="resetBtn">üßπ clear tower</button>
            <div class="slider-block">
              <label>üåç gravity <span id="gravityValue">0.5</span></label>
              <input type="range" id="gravitySlider" min="0.1" max="1.5" step="0.05" value="0.5">
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- collapse log -->
    <div class="collapse-log">
      <div class="log-header">
        <span>üìã</span> structural log
      </div>
      <div id="logContainer">‚ú® build a tower, then simulate</div>
    </div>
  </div>

  <script>
    (function() {
      const canvas = document.getElementById('towerCanvas');
      const ctx = canvas.getContext('2d');
      const blockPalette = document.getElementById('blockPalette');
      const blockCounter = document.getElementById('blockCounter');
      const stressIndicator = document.getElementById('stressIndicator');
      const simulateBtn = document.getElementById('simulateBtn');
      const resetBtn = document.getElementById('resetBtn');
      const gravitySlider = document.getElementById('gravitySlider');
      const gravityValue = document.getElementById('gravityValue');
      const logContainer = document.getElementById('logContainer');

      // block library
      const blockTypes = [
        { emoji: 'üß±', name: 'brick', weight: 1.0, color: '#b87333' },
        { emoji: 'ü™®', name: 'stone', weight: 1.8, color: '#7e7e7e' },
        { emoji: 'ü™µ', name: 'wood', weight: 0.6, color: '#8b5a2b' },
        { emoji: 'üßä', name: 'ice', weight: 0.4, color: '#a5d6ff' },
        { emoji: '‚öôÔ∏è', name: 'metal', weight: 2.2, color: '#708090' },
        { emoji: 'üß™', name: 'glass', weight: 0.7, color: '#b0e0e6' }
      ];

      let currentBlockIndex = 2; // default wood
      let blocks = []; // { x, y, width, height, typeIndex, id, stable }
      let GRAVITY = 0.5;
      let isSimulating = false;
      let simInterval = null;

      // canvas dimensions
      let width = canvas.width;
      let height = canvas.height;

      // render block palette
      function renderPalette() {
        let html = '';
        blockTypes.forEach((b, idx) => {
          html += `
            <div class="block-card ${idx === currentBlockIndex ? 'active' : ''}" data-index="${idx}">
              <span class="block-emoji">${b.emoji}</span>
              <span class="block-weight">${b.weight} t</span>
            </div>
          `;
        });
        blockPalette.innerHTML = html;

        document.querySelectorAll('.block-card').forEach(card => {
          card.addEventListener('click', () => {
            document.querySelectorAll('.block-card').forEach(c => c.classList.remove('active'));
            card.classList.add('active');
            currentBlockIndex = parseInt(card.dataset.index, 10);
          });
        });
      }

      // draw tower
      function drawTower() {
        ctx.clearRect(0, 0, width, height);

        // ground
        ctx.fillStyle = '#4f664c';
        ctx.fillRect(0, height - 20, width, 20);
        ctx.fillStyle = '#7b8f70';
        ctx.fillRect(0, height - 20, width, 5);

        // draw each block
        blocks.forEach(b => {
          const type = blockTypes[b.typeIndex];
          ctx.fillStyle = type.color;
          ctx.shadowColor = '#00000080';
          ctx.shadowBlur = 8;
          ctx.fillRect(b.x, b.y, b.width, b.height);
          ctx.shadowBlur = 0;
          ctx.strokeStyle = '#2a281c';
          ctx.lineWidth = 2;
          ctx.strokeRect(b.x, b.y, b.width, b.height);
          ctx.font = '24px "Segoe UI Emoji"';
          ctx.fillStyle = '#1a1a1a';
          ctx.fillText(type.emoji, b.x + 10, b.y + 30);
        });
      }

      // add block at mouse click
      function addBlock(mx, my) {
        const blockWidth = 70;
        const blockHeight = 50;
        const x = mx - blockWidth / 2;
        const y = my - blockHeight / 2;

        // boundary constraints
        if (x < 10 || x + blockWidth > width - 10 || y < 10 || y + blockHeight > height - 30) return;

        // check overlap
        for (let b of blocks) {
          if (!(x + blockWidth < b.x || x > b.x + b.width || y + blockHeight < b.y || y > b.y + b.height)) {
            logContainer.innerText = '‚ö†Ô∏è blocks cannot overlap';
            return;
          }
        }

        blocks.push({
          id: 'block_' + Date.now() + '_' + Math.random().toString(36).substr(2, 6),
          x, y,
          width: blockWidth,
          height: blockHeight,
          typeIndex: currentBlockIndex,
          stable: true
        });
        updateBlockCounter();
        drawTower();
        logContainer.innerText = '‚úÖ block placed';
      }

      canvas.addEventListener('click', (e) => {
        if (isSimulating) return;
        const rect = canvas.getBoundingClientRect();
        const scaleX = canvas.width / rect.width;
        const scaleY = canvas.height / rect.height;
        const mx = (e.clientX - rect.left) * scaleX;
        const my = (e.clientY - rect.top) * scaleY;
        addBlock(mx, my);
      });

      // update block counter
      function updateBlockCounter() {
        blockCounter.innerText = blocks.length + ' block' + (blocks.length !== 1 ? 's' : '');
      }

      // ---- physics / collapse simulation ----
      function applyGravity() {
        let anyMoved = false;
        // sort by y (bottom first for stability)
        const sorted = [...blocks].sort((a, b) => b.y - a.y);

        for (let b of sorted) {
          // find support below
          let supportY = height - 20; // ground level (top of ground)
          for (let other of blocks) {
            if (other.id === b.id) continue;
            // vertical overlap check (support if within x range)
            if (b.x < other.x + other.width && b.x + b.width > other.x && other.y > b.y) {
              // other is below
              if (other.y < supportY) {
                supportY = other.y;
              }
            }
          }
          // target y: just above support or ground
          let targetY = supportY - b.height;
          if (targetY < 10) targetY = 10; // keep in canvas

          if (Math.abs(b.y - targetY) > 1) {
            b.y += (targetY - b.y) * 0.3; // smooth movement
            anyMoved = true;
          }
        }

        // detect collapse (if any block falls below threshold)
        for (let b of blocks) {
          if (b.y + b.height > height - 15) {
            // block hit ground safely, but if it's too fast? we'll log
          }
        }

        return anyMoved;
      }

      function checkStructuralFailure() {
        // simple stress: if a block has no support directly beneath its center
        let failed = false;
        for (let b of blocks) {
          const centerX = b.x + b.width / 2;
          const bottomY = b.y + b.height;
          let supported = false;

          // ground support
          if (bottomY >= height - 20 - 2) {
            supported = true;
          } else {
            for (let other of blocks) {
              if (other.id === b.id) continue;
              if (centerX > other.x && centerX < other.x + other.width &&
                  Math.abs(bottomY - other.y) < 5) {
                supported = true;
                break;
              }
            }
          }

          if (!supported) {
            failed = true;
            logContainer.innerText = `üí• collapse: ${blockTypes[b.typeIndex].name} unsupported`;
            stressIndicator.innerText = 'üíî collapsed';
            return true;
          }
        }
        stressIndicator.innerText = '‚öñÔ∏è stable';
        return false;
      }

      function simulationStep() {
        const moved = applyGravity();
        drawTower();
        if (checkStructuralFailure()) {
          stopSimulation();
          logContainer.innerText = 'üèöÔ∏è tower collapsed!';
        }
        if (!moved) {
          stopSimulation();
          logContainer.innerText = '‚úÖ simulation settled';
        }
      }

      function startSimulation() {
        if (isSimulating) return;
        if (blocks.length === 0) {
          logContainer.innerText = '‚ö†Ô∏è no blocks to simulate';
          return;
        }
        isSimulating = true;
        logContainer.innerText = 'üåÄ simulating...';
        simInterval = setInterval(simulationStep, 50);
      }

      function stopSimulation() {
        if (simInterval) {
          clearInterval(simInterval);
          simInterval = null;
        }
        isSimulating = false;
      }

      simulateBtn.addEventListener('click', () => {
        if (isSimulating) {
          stopSimulation();
          logContainer.innerText = '‚è∏Ô∏è simulation paused';
        } else {
          startSimulation();
        }
      });

      resetBtn.addEventListener('click', () => {
        stopSimulation();
        blocks = [];
        drawTower();
        updateBlockCounter();
        stressIndicator.innerText = '‚öñÔ∏è stable';
        logContainer.innerText = '‚ú® tower cleared';
      });

      gravitySlider.addEventListener('input', (e) => {
        GRAVITY = parseFloat(e.target.value);
        gravityValue.innerText = GRAVITY.toFixed(2);
      });

      // initial
      renderPalette();

      // demo blocks
      function initDemo() {
        blocks.push({
          id: 'base1',
          x: 200, y: 400,
          width: 70, height: 50,
          typeIndex: 0,
          stable: true
        });
        blocks.push({
          id: 'base2',
          x: 300, y: 400,
          width: 70, height: 50,
          typeIndex: 1,
          stable: true
        });
        blocks.push({
          id: 'top',
          x: 250, y: 340,
          width: 70, height: 50,
          typeIndex: 2,
          stable: true
        });
        updateBlockCounter();
        drawTower();
      }
      initDemo();
    })();
  </script>
</body>
</html>